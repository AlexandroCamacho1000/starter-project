rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- USERS COLLECTION ---
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer cualquier perfil
      allow read: if request.auth != null;
      
      // Solo el propio usuario puede crear/actualizar su perfil
      allow create: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.keys().hasAll(['email', 'name', 'role']) &&
                      request.resource.data.role in ['journalist', 'editor', 'admin'];
      
      allow update: if request.auth != null && 
                      request.auth.uid == userId;
    }
    
    // --- ARTICLES COLLECTION ---
    match /articles/{articleId} {
      // Cualquiera puede leer artículos publicados
      // Solo el autor puede leer sus borradores
      allow read: if resource.data.published == true || 
                    (request.auth != null && request.auth.uid == resource.data.authorId);
      
      // Crear artículo: solo usuarios autenticados, deben ser el autor
      allow create: if request.auth != null &&
                      request.resource.data.authorId == request.auth.uid &&
                      // Validar estructura del esquema
                      request.resource.data.keys().hasAll(['title', 'content', 'authorId', 'thumbnailURL', 'published', 'createdAt']) &&
                      // thumbnailURL debe apuntar a media/articles/
                      request.resource.data.thumbnailURL is string &&
                      request.resource.data.thumbnailURL.matches('^media/articles/') &&
                      // Validar tipos de datos
                      request.resource.data.title is string &&
                      request.resource.data.content is string &&
                      request.resource.data.published is bool;
      
      // Actualizar: solo el autor
      allow update: if request.auth != null && 
                      request.auth.uid == resource.data.authorId;
      
      // Eliminar: solo el autor
      allow delete: if request.auth != null && 
                      request.auth.uid == resource.data.authorId;
    }
  }
}