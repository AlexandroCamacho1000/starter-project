rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== ARTICLES ==========
    match /articles/{articleId} {
      // Lectura pública
      allow read: if true;
      
      // Solo usuarios autenticados pueden escribir
      allow write: if request.auth != null;
      
      // Validaciones específicas del schema
      allow create: if 
        // Título: string, 3-200 chars
        request.resource.data.title is string &&
        request.resource.data.title.size() >= 3 &&
        request.resource.data.title.size() <= 200 &&
        
        // Descripción: opcional
        (request.resource.data.description is string || 
         request.resource.data.description == null) &&
         
        // Contenido: string, mínimo 10 chars
        request.resource.data.content is string &&
        request.resource.data.content.size() >= 10 &&
        
        // AuthorId: debe ser el usuario actual
        request.resource.data.authorId is string &&
        request.resource.data.authorId == request.auth.uid &&
        
        // thumbnailURL: debe apuntar a media/articles/
        request.resource.data.thumbnailURL is string &&
        request.resource.data.thumbnailURL.matches('^media/articles/.*') &&
        
        // publishedAt: timestamp obligatorio
        request.resource.data.publishedAt is timestamp &&
        
        // Tags: opcional, array si existe
        (request.resource.data.tags is list || 
         request.resource.data.tags == null);
    }
    
    // ========== USERS ==========
    match /users/{userId} {
      // Lectura pública
      allow read: if true;
      
      // Solo el usuario puede editar su perfil
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Storage para thumbnails de artículos
    match /media/articles/{imageId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Storage para fotos de perfil
    match /media/users/{userId}/{imageId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}